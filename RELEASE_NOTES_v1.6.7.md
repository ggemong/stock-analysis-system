# Stock Analysis System v1.6.7 - 릴리스 노트

## 🎯 핵심 수정사항

### 김치프리미엄이 텔레그램에 표시되지 않던 문제 완전 해결!

**문제**: 
- 텔레그램에서 "🌶️ 김치 프리미엄" 타이틀은 나오는데 내용이 비어있음
- 로그에서는 데이터가 정상 수집됨
- JSON 파일에도 데이터가 정상적으로 저장됨

**원인**:
```
총 메시지 길이: 5097자
텔레그램 제한: 4096자
→ 메시지가 잘려서 전송됨!
```

텔레그램 API의 메시지당 4096자 제한 때문에, 긴 분석 리포트가 중간에 잘리면서 김치프리미엄 섹션이 손실되었습니다.

---

## ✨ 새로운 기능

### 1. 텔레그램 메시지 자동 분할 시스템

```python
def send_message(self, text: str) -> bool:
    """텍스트 메시지 전송 (4096자 초과 시 자동 분할)"""
    MAX_LENGTH = 4096
    
    if len(text) <= MAX_LENGTH:
        return self._send_single_message(text)
    
    # 섹션 단위로 스마트 분할
    sections = text.split('\n\n')
    # ... 분할 로직 ...
```

**기능:**
- ✅ 4096자 초과 메시지 자동 감지
- ✅ 섹션 단위로 스마트 분할 (내용 보존)
- ✅ 순차적 메시지 전송
- ✅ 부분 실패 시에도 전송 가능한 부분은 모두 전송

### 2. 상세 로그 개선

```
메시지가 길어서(5097자) 분할 전송합니다...
총 2개 메시지로 분할
메시지 1/2 전송 중 (4095자)...
✅ 모든 메시지 전송 성공 (2/2)
```

---

## 📊 실행 결과 예시

### Before (v1.6.6)
```
텔레그램 메시지:
📊 주식 시장 분석 리포트
💱 환율
📈 거시경제 지표
🌶️ 김치 프리미엄
[여기서 메시지가 잘림]
```

### After (v1.6.7)
```
텔레그램 메시지 1:
📊 주식 시장 분석 리포트
💱 환율
📈 거시경제 지표
🌶️ 김치 프리미엄
📈 BTC: +2.6% (프리미엄)
📈 ETH: +2.6% (프리미엄)
📈 XRP: +2.6% (프리미엄)
📈 SOL: +2.6% (프리미엄)
📈 ADA: +2.8% (프리미엄)

텔레그램 메시지 2:
🎯 보유 주식 분석
... (나머지 내용)
```

---

## 🔍 기술적 세부사항

### 메시지 분할 알고리즘

1. **섹션 단위 분할** (`\n\n` 기준)
   - 섹션의 완결성 유지
   - 읽기 편한 단위로 자연스럽게 분할

2. **초대형 섹션 처리**
   - 섹션 자체가 4096자 초과 시
   - 줄 단위로 2차 분할

3. **순차 전송**
   - 메시지 순서 보장
   - 부분 실패 허용 (일부라도 전송)

### 에러 처리 개선

```python
# 전체 성공 여부
if success_count == len(messages):
    logger.info(f"✅ 모든 메시지 전송 성공 ({success_count}/{len(messages)})")
    return True
elif success_count > 0:
    logger.warning(f"⚠️ 일부 메시지 전송 성공 ({success_count}/{len(messages)})")
    return True  # 일부 성공도 성공으로 간주
```

---

## 📋 업그레이드 가이드

### 1단계: 기존 시스템 백업

```bash
cd stock-analysis-system
cp src/notifiers/telegram_notifier.py src/notifiers/telegram_notifier.py.backup
```

### 2단계: 새 버전 적용

```bash
# 기존 시스템 디렉토리로 이동
cd stock-analysis-system

# 새 파일 복사 (telegram_notifier.py만 업데이트)
cp /path/to/new/telegram_notifier.py src/notifiers/
```

또는 전체 시스템 재설치:

```bash
tar -xzf stock-analysis-system-v1_6_7-final.tar.gz
cd stock-analysis-system
# 기존 .env 파일 복사
cp ../old-system/.env .
```

### 3단계: 테스트 실행

```bash
python main.py --test
```

### 4단계: 로그 확인

```bash
tail -f stock_analysis.log
```

다음과 같은 로그가 보이면 성공:

```
메시지가 길어서(5097자) 분할 전송합니다...
총 2개 메시지로 분할
메시지 1/2 전송 중 (4095자)...
메시지 2/2 전송 중 (1002자)...
✅ 모든 메시지 전송 성공 (2/2)
```

---

## 🧪 테스트 결과

### 테스트 환경
- 16개 주식 포트폴리오
- 5개 암호화폐 김치프리미엄
- 거시경제 지표 포함
- 총 메시지 길이: 5097자

### 결과
- ✅ 메시지 2개로 자동 분할
- ✅ 모든 섹션 정상 표시
- ✅ 김치프리미엄 데이터 완전 표시
- ✅ 0초 지연 없이 순차 전송

---

## 🔧 추가 개선사항

### 향후 고려사항
1. **메시지 압축**: 주식 개수가 많을 경우 요약 모드 옵션
2. **선택적 섹션**: 환경변수로 표시할 섹션 선택
3. **Gemini 요약**: 긴 분석을 Gemini가 요약해서 전송

---

## 💡 FAQ

### Q: 메시지가 여러 개로 나뉘어서 오는데 정상인가요?
**A:** 네, 정상입니다! 텔레그램은 메시지당 4096자 제한이 있어서, 긴 리포트는 자동으로 분할됩니다. 모든 내용은 순서대로 전송됩니다.

### Q: 첫 번째 메시지만 오고 나머지가 안 오면?
**A:** 로그 파일을 확인하세요:
```bash
grep "메시지 전송" stock_analysis.log
```
부분 실패 시 어떤 메시지가 실패했는지 확인할 수 있습니다.

### Q: 메시지를 하나로 합칠 수 없나요?
**A:** 텔레그램 API 제한(4096자)으로 불가능합니다. 대안:
- JSON 파일에 전체 데이터가 있습니다
- Gemini에게 요약을 요청할 수 있습니다

### Q: 김치프리미엄만 별도 메시지로 받을 수 있나요?
**A:** 가능합니다! `telegram_notifier.py`를 수정하여 김치프리미엄을 별도 메시지로 전송하도록 커스터마이징할 수 있습니다.

---

## 📞 지원

문제 발생 시:
1. 로그 파일 확인: `cat stock_analysis.log | grep "메시지"`
2. 텔레그램 봇 상태 확인: `python main.py --test`
3. LOG_GUIDE.md 참조

---

**버전**: v1.6.7  
**릴리스 날짜**: 2025-01-31  
**이전 버전**: v1.6.6  
**호환성**: Python 3.8+  
**주요 변경**: 텔레그램 메시지 자동 분할 기능 추가
